version: "3.9"

networks:
  web: {}

volumes:
  traefik_letsencrypt: {}

services:
  traefik:
    image: traefik:v2.11
    container_name: traefik
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --certificatesresolvers.le.acme.email=${LETSENCRYPT_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge=true
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
    ports:
      - "80:80"
      - "443:443"
    networks: [web]
    volumes:
      - traefik_letsencrypt:/letsencrypt
      - /var/run/docker.sock:/var/run/docker.sock:ro

  web-personal:
    image: nginx:alpine
    container_name: web-personal
    restart: unless-stopped
    networks: [web]
    volumes:
      - ./web-personal:/usr/share/nginx/html:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.personal.rule=Host(`${DOMAIN}`) && PathPrefix(`/`)
      - traefik.http.routers.personal.entrypoints=websecure
      - traefik.http.routers.personal.tls.certresolver=le
      - traefik.http.routers.personal.priority=1

  presentacion:
    image: nginx:alpine
    container_name: presentacion
    restart: unless-stopped
    networks: [web]
    volumes:
      - ./presentacion:/usr/share/nginx/html/presentacion:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.presentacion.rule=Host(`${DOMAIN}`) && PathPrefix(`/presentacion`)
      - traefik.http.routers.presentacion.entrypoints=websecure
      - traefik.http.routers.presentacion.tls.certresolver=le
      - traefik.http.routers.presentacion.priority=10

  clinicavm-frontend:
    image: nginx:alpine
    container_name: clinicavm-frontend
    restart: unless-stopped
    networks: [web]
    volumes:
      - ./clinicavm/dist:/usr/share/nginx/html:ro
      - ./clinicavm/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.clinicavm.rule=Host(`${DOMAIN}`) && PathPrefix(`/clinicavm`)
      - traefik.http.routers.clinicavm.entrypoints=websecure
      - traefik.http.routers.clinicavm.tls.certresolver=le
      - traefik.http.routers.clinicavm.priority=20

  clinicavm-php:
    image: php:8.3-fpm-alpine
    container_name: clinicavm-php
    restart: unless-stopped
    working_dir: /var/www/html
    networks: [web]
    volumes:
      - ./api/app:/var/www/html
    # Extensiones necesarias tÃ­picas
    command: >
      sh -c "apk add --no-cache icu-dev libpng-dev libzip-dev oniguruma-dev git bash
      && docker-php-ext-configure intl
      && docker-php-ext-install intl pdo_mysql zip bcmath
      && php-fpm"
    environment:
      PHP_MEMORY_LIMIT: 512M

  clinicavm-api:
    image: nginx:alpine
    container_name: clinicavm-api
    restart: unless-stopped
    depends_on: [clinicavm-php]
    networks: [web]
    volumes:
      - ./api/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./api/app:/var/www/html:ro
    labels:
      - traefik.enable=true
      # Publicar bajo /clinicavm/api (con HTTPS)
      - traefik.http.routers.clinicavm_api.rule=Host(`${DOMAIN}`) && PathPrefix(`/clinicavm/api`)
      - traefik.http.routers.clinicavm_api.entrypoints=websecure
      - traefik.http.routers.clinicavm_api.tls.certresolver=le
      # Quita el prefijo /clinicavm antes de llegar a Nginx/Laravel -> /api/...
      - traefik.http.middlewares.strip-clinicavm.stripprefix.prefixes=/clinicavm
      - traefik.http.routers.clinicavm_api.middlewares=strip-clinicavm
      - traefik.http.routers.clinicavm_api.priority=30